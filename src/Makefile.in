# $Id$
@MCOMMON@

LINT = lint -DNARROWPROTO=1 $(XINC) -chapbxz

srcdir =	@srcdir@
VPATH =		@srcdir@
.PATH:		@srcdir@

top_builddir = ..
basedir = ..
thisdir = src
MKDIR = @top_srcdir@/autoconf/mkinstalldirs

# for developers: the following debug options may be used
#	-DDEBUG_CMD -DDEBUG_MAIN -DDEBUG_MENU -DDEBUG_MENUARROWS
#	-DDEBUG_MENUBAR_STACKING -DDEBUG_MENU_LAYOUT -DDEBUG_RESOURCES
#	-DDEBUG_SEARCH_PATH -DDEBUG_SIZE -DDEBUG_TTY -DDEBUG_TTYMODE
DEBUG=-DDEBUG_STRICT @DEBUG@

first_rule: all
dummy:

LIBSRCS = command.C rxvtfont.C init.C logging.C \
	main.C menubar.C misc.C netdisp.C ptytty.C screen.C scrollbar.C \
	scrollbar-rxvt.C scrollbar-next.C scrollbar-xterm.C strings.C \
	xdefaults.C xpm.C encoding.C rxvttoolkit.C rxvtutil.C iom.C \
	scrollbar-plain.C

SRCS =  rxvt.C $(LIBSRCS)

HDRS =	command.h rxvtfont.h feature.h init.h logging.h \
	menubar.h netdisp.h rxvt.h rxvtgrx.h version.h encoding.h \
	rxvtutil.h iom.h iom_conf.h

EXTRAHDRS = rxvtlib.h rxvtdaemon.h

OBJS =	command.o rxvtfont.o init.o logging.o \
	main.o menubar.o misc.o netdisp.o ptytty.o screen.o \
	scrollbar.o scrollbar-next.o scrollbar-rxvt.o scrollbar-xterm.o scrollbar-plain.o \
	strings.o xdefaults.o xpm.o rxvt.o encoding.o rxvttoolkit.o rxvtutil.o iom.o
LIBOBJS = command.lo rxvtfont.lo init.lo logging.lo \
	main.lo menubar.lo misc.lo netdisp.lo ptytty.lo screen.lo \
	scrollbar.lo scrollbar-next.lo scrollbar-rxvt.lo scrollbar-xterm.lo scrollbar-plain.lo \
	strings.lo xdefaults.lo xpm.lo encoding.lo rxvt.lo rxvttoolkit.lo rxvtutil.lo iom.lo

LIBVERSION = @LIBVERSION@
INSTALL_LIBRXVT = @INSTALL_LIBRXVT@

RXVT_BASENAME=`$(ECHO) $(RXVTNAME)|$(SED) 's/$(EXEEXT)$$//'|$(SED) '$(transform)'`
RXVT_BINNAME=$(DESTDIR)$(bindir)/$(RXVT_BASENAME)$(EXEEXT)
RXVTC_BINNAME=$(DESTDIR)$(bindir)/$(RXVT_BASENAME)c$(EXEEXT)
RXVTD_BINNAME=$(DESTDIR)$(bindir)/$(RXVT_BASENAME)d$(EXEEXT)
RXVT_OLDNAME=$(DESTDIR)$(bindir)/$(RXVT_BASENAME)-old$(EXEEXT)

INTPROS = rxvtfont.intpro logging.intpro main.intpro misc.intpro \
	ptytty.intpro xpm.intpro

DEPS =  rxvt.h rxvtlib.h ${basedir}/config.h feature.h rxvttoolkit.h

#
# Distribution variables
#

DIST = $(HDRS) $(SRCS) Makefile.in gcc-Wall rxvtlib.h.in $(INTPROS)

.SUFFIXES:	.C .o .intpro .lo

#-------------------------------------------------------------------------
# inference rules
.C.o:
	$(COMPILE) -c $<

.C.lo:
	$(LIBTOOL) --mode=compile $(COMPILE) -c $<

.s.lo:
	$(LIBTOOL) --mode=compile $(COMPILE) -c $<

.S.lo:
	$(LIBTOOL) --mode=compile $(COMPILE) -c $<

.C.intpro:
	@$(RMF) $@.tmp
	@$(AWK) -f $(srcdir)/makeintprotos-awk $< > $@.tmp
	@if $(CMP) -s $@ $@.tmp ; then : ; else $(ECHO) "$(AWK) -f $(srcdir)/makeintprotos-awk $< > $@"; $(CP) $@.tmp $@; fi
	@$(RMF) $@.tmp

#-------------------------------------------------------------------------

all: allbin

rxvt: version.h rxvt.o librxvt.la
	$(LIBTOOL) --mode=link $(LINK) rxvt.o librxvt.la $(LIBS) $(XLIB) $(DLIB) -o $@

rxvtd: version.h rxvtd.o librxvt.la rxvtdaemon.o
	$(LIBTOOL) --mode=link $(LINK) rxvtd.o rxvtdaemon.o librxvt.la $(LIBS) $(XLIB) $(DLIB) -o $@

rxvtc: version.h rxvtc.o rxvtdaemon.o
	$(LIBTOOL) --mode=link $(LINK) rxvtc.o rxvtdaemon.o $(LIBS) $(DLIB) -o $@

librxvt.la: $(LIBOBJS)
	$(LIBTOOL) --mode=link $(LINK) -rpath $(libdir) -version-info $(LIBVERSION) $(LIBOBJS) $(LIBS) -o $@

#-------------------------------------------------------------------------

tags: $(SRCS) $(HDRS) $(EXTRAHDRS)
	ctags $(SRCS) $(HDRS) $(EXTRAHDRS)

allbin: rxvt rxvtd rxvtc

alldoc:

clean:
	$(RMF) rxvt rxvtc rxvtd core a.out *.o *.lo *.bak *~ *.intpro .libs/* librxvt.la tmpproto *.tmp

realclean: clean
	$(RMF) tags librxvt.h

cleandir: realclean

distclean: realclean
	if test $(srcdir) = .; then $(MAKE) realclean; fi
	(cd $(srcdir); $(RMF) Makefile)

install: allbin alldoc
	$(MKDIR) $(DESTDIR)$(includedir) $(DESTDIR)$(libdir) $(DESTDIR)$(bindir)
	@if test x$(INSTALL_LIBRXVT) = xyes; then \
	    $(ECHO) "$(LIBTOOL) --mode=install $(INSTALL_DATA) rxvtlib.h $(DESTDIR)$(includedir)/rxvtlib.h"; \
	    $(LIBTOOL) --mode=install $(INSTALL_DATA) rxvtlib.h $(DESTDIR)$(includedir)/rxvtlib.h; \
	    $(ECHO) "$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) librxvt.la $(DESTDIR)$(libdir)/librxvt.la"; \
	    $(LIBTOOL) --mode=install $(INSTALL_PROGRAM) librxvt.la $(DESTDIR)$(libdir)/librxvt.la; \
	fi
	$(RMF) $(RXVT_BINNAME)
	$(RMF) $(RXVTC_BINNAME)
	$(RMF) $(RXVTD_BINNAME)
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) rxvt  $(RXVT_BINNAME)
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) rxvtc $(RXVTC_BINNAME)
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) rxvtd $(RXVTD_BINNAME)

uninstall:
	@$(ECHO) $(RMF) $(RXVT_VERNAME)
	@$(RMF) $(RXVT_VERNAME)
	@$(ECHO) "$(LIBTOOL) --mode=uninstall $(RMF) $(RXVT_BINNAME)"
	@$(LIBTOOL) --mode=uninstall $(RMF) $(RXVT_BINNAME)
	@if test x$(INSTALL_LIBRXVT) = xyes; then \
	    $(ECHO) "$(LIBTOOL) --mode=uninstall $(RMF) $(DESTDIR)$(libdir)/librxvt.la"; \
	    $(LIBTOOL) --mode=uninstall $(RMF) $(DESTDIR)$(libdir)/librxvt.la; \
	    $(ECHO) "$(LIBTOOL) --mode=uninstall $(RMF) $(DESTDIR)$(includedir)/rxvtlib.h"; \
	    $(LIBTOOL) --mode=uninstall $(RMF) $(DESTDIR)$(includedir)/rxvtlib.h; \
	fi

distdirs:
	mkdir $(basedir)/../$(VERNAME)/$(thisdir)

distcopy: $(INTPROS)
	$(CP) -p $(DIST) $(basedir)/../$(VERNAME)/$(thisdir)

# -----------------------------------------------------------------------
# DO NOT DELETE: nice dependency list follows
#

rxvtfont.h: encoding.h rxvtutil.h
rxvtlib.h: rxvttoolkit.h rxvtfont.h
rxvtdaemon.o:       rxvtdaemon.C $(DEPS) rxvtdaemon.h
rxvtd.o:            rxvtd.C     $(DEPS) rxvtdaemon.h rxvtutil.h
rxvtc.o:            rxvtc.C     $(DEPS) rxvtdaemon.h rxvtutil.h

command.o:          command.C   $(DEPS) command.h version.h
rxvtfont.o:         rxvtfont.C  $(DEPS) rxvtfont.h
init.o:             init.C      $(DEPS) init.h	rxvtfont.h
logging.o:          logging.C   $(DEPS) logging.intpro	logging.h
main.o:             main.C      $(DEPS) main.intpro
menubar.o:          menubar.C   $(DEPS) menubar.h version.h
misc.o:             misc.C      $(DEPS) misc.intpro
netdisp.o:          netdisp.C   $(DEPS) netdisp.h
ptytty.o:           ptytty.C    $(DEPS) ptytty.intpro
rxvt.o:             rxvt.C      $(DEPS) 
screen.o:           screen.C    $(DEPS) rxvtfont.h
scrollbar.o:        scrollbar.C $(DEPS)
scrollbar-rxvt.o:   scrollbar-rxvt.C  $(DEPS)
scrollbar-next.o:   scrollbar-next.C  $(DEPS)
scrollbar-xterm.o:  scrollbar-xterm.C $(DEPS)
scrollbar-plain.o:  scrollbar-plain.C $(DEPS)
strings.o:          strings.C   $(DEPS)
xdefaults.o:        xdefaults.C $(DEPS) version.h
xpm.o:              xpm.C       $(DEPS) xpm.intpro
encoding.o:         encoding.C	$(DEPS) encoding.h
rxvttoolkit.o:      rxvttoolkit.C	$(DEPS)
iom.o:              iom.C	$(DEPS)	iom.h

command.lo:         command.C   $(DEPS) version.h
rxvtfont.lo:        rxvtfont.C  $(DEPS) rxvtfont.h encoding.h
init.lo:            init.C      $(DEPS) init.intpro	init.h	
logging.lo:         logging.C   $(DEPS) logging.intpro	logging.h
main.lo:            main.C      $(DEPS) main.intpro
menubar.lo:         menubar.C   $(DEPS) version.h
misc.lo:            misc.C      $(DEPS) misc.intpro
netdisp.lo:         netdisp.C   $(DEPS) netdisp.h
ptytty.lo:          ptytty.C    $(DEPS) ptytty.intpro
rxvt.lo:            rxvt.C      $(DEPS) 
screen.lo:          screen.C    $(DEPS) rxvtfont.h
scrollbar.lo:       scrollbar.C $(DEPS)
scrollbar-rxvt.lo:  scrollbar-rxvt.C  $(DEPS)
scrollbar-next.lo:  scrollbar-next.C  $(DEPS)
scrollbar-xterm.lo: scrollbar-xterm.C $(DEPS)
scrollbar-plain.lo: scrollbar-plain.C $(DEPS)
strings.lo:         strings.C   $(DEPS)
xdefaults.lo:       xdefaults.C $(DEPS) version.h
xpm.lo:             xpm.C       $(DEPS) xpm.intpro
encoding.lo:        encoding.C	$(DEPS) encoding.h
rxvttoolkit.lo:     rxvttoolkit.C	$(DEPS)
iom.lo:             iom.C	$(DEPS)	iom.h


