#! perl

# same url as used in "selection"
my $url =
   qr{(
      (?:https?|ftp|news|mailto|file)://[ab-zA-Z0-9\-\@;\/?:&=%\$_.+!*\x27(),~]+
      [ab-zA-Z0-9\-\@;\/?:&=%\$_+!*\x27()~]   # exclude some trailing characters (heuristic)
   )}x;

sub on_line_update {
   my ($self, $row) = @_;

   # fetch the line that has changed
   my $line = $self->line ($row);
   my $text = $line->t;

   # find all urls (if any)
   while ($text =~ /$url/g) {
      my $rend = $line->r;

      # mark all characters as underlined. we _must_ not toggle underline,
      # as we might get called on an already-marked url.
      $_ |= urxvt::RS_Uline
         for @{$rend}[ $-[1] .. $+[1] - 1];

      $line->r ($rend);
   }

   ()
}

# needs confgiurability TODO
#sub on_button_press {
#    my ($self, $event) = @_;
#    my $row = $event->{row};
#    my $col =  $event->{col};
#
#    my $line = $self->line ($row);
#    my $text = $line->t;
#
#    while($text =~ /$url/g) {
#        #print "... " . ($-[0] 
#        if ($-[0] <= $col && $+[0] >= $col) {
#            system "firefox \Q$1\E &";
#            return 1;
#        }
#    }
#    ()
#}

